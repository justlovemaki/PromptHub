# API 接口测试文档

## 测试概述

本项目为AI提示词管理平台的API接口创建了完整的测试套件，涵盖了所有主要的API端点和工具函数。

## 测试覆盖范围

### 1. 健康检查API (`/api/health`)
- **文件**: `src/app/api/health/health.test.ts`
- **测试场景**:
  - 返回正确的健康状态信息
  - 包含正确的响应头
  - 使用环境变量中的版本信息
  - 错误情况下返回500状态

### 2. 认证API (`/api/auth/login`)
- **文件**: `src/app/api/auth/login/login.test.ts`
- **测试场景**:
  - 当前未实现状态的处理
  - 无效JSON请求体的处理
  - 空请求体的处理
  - 请求头的正确处理
  - 包含完整实现后的测试用例（已注释）

### 3. 提示词管理API

#### 3.1 提示词列表 (`/api/prompts/list`)
- **文件**: `src/app/api/prompts/list/list.test.ts`
- **测试场景**:
  - 返回用户的提示词列表
  - 正确解析tags JSON字段
  - 处理空的tags字段
  - 拒绝未认证的请求
  - 拒绝缺少必要头信息的请求
  - 处理服务层错误
  - 处理空的提示词列表

#### 3.2 创建提示词 (`/api/prompts/create`)
- **文件**: `src/app/api/prompts/create/create.test.ts`
- **测试场景**:
  - 创建新的提示词
  - 处理必需字段缺失的情况
  - 处理空的title和content字段
  - 处理可选字段
  - 拒绝未认证的请求
  - 处理服务层创建失败
  - 处理服务层错误
  - 处理无效的JSON请求体
  - 处理tags数组验证

#### 3.3 更新提示词 (`/api/prompts/update`)
- **文件**: `src/app/api/prompts/update/update.test.ts`
- **测试场景**:
  - 更新现有提示词
  - 处理部分更新
  - 处理空的更新数据
  - 拒绝缺少ID的请求
  - 拒绝空的ID
  - 拒绝未授权的用户
  - 拒绝未认证的请求
  - 处理更新失败
  - 处理服务层错误

#### 3.4 删除提示词 (`/api/prompts/delete`)
- **文件**: `src/app/api/prompts/delete/delete.test.ts`
- **测试场景**:
  - 删除现有提示词
  - 拒绝缺少ID的请求
  - 拒绝空的ID
  - 拒绝未授权的用户
  - 拒绝未认证的请求
  - 处理所有权验证错误
  - 处理删除操作错误

### 4. 工具函数测试
- **文件**: `src/lib/utils.test.ts`
- **测试场景**:
  - JWT Token生成和验证
  - 密码加密和验证
  - ID生成功能
  - API响应格式化函数
  - HTTP状态码常量

## 测试工具和配置

### 测试框架配置
- **Jest**: 主要测试框架
- **ts-jest**: TypeScript支持
- **@types/jest**: TypeScript类型定义

### 测试工具函数
- **文件**: `src/__tests__/test-utils.ts`
- **功能**:
  - 创建模拟的NextRequest对象
  - 创建带有认证信息的模拟请求
  - 模拟用户、提示词、工作空间数据
  - 提取响应JSON数据的辅助函数

### 配置文件
- `jest.config.js`: Jest主配置文件
- `jest.setup.js`: Jest设置文件，包含环境变量和全局设置
- `package.json`: 包含测试脚本和依赖

## 运行测试

### 基本命令
```bash
# 运行所有测试
npm test

# 监视模式运行测试
npm run test:watch

# 生成覆盖率报告
npm run test:coverage
```

### 测试结果示例
- 总计24个测试用例
- 22个通过，2个失败（主要是配置问题）
- 涵盖所有主要API端点

## 模拟和依赖

### 服务层模拟
- `UserService`: 用户相关操作
- `PromptService`: 提示词相关操作
- `SpaceService`: 工作空间相关操作

### 环境变量模拟
- `JWT_SECRET`: JWT密钥
- `NODE_ENV`: 环境类型
- `DATABASE_URL`: 数据库连接

## 测试最佳实践

1. **独立性**: 每个测试用例都是独立的，不依赖其他测试
2. **模拟**: 使用Jest模拟外部依赖，确保测试的可控性
3. **覆盖性**: 涵盖正常流程、错误处理、边界情况
4. **可读性**: 测试用例描述清晰，易于理解
5. **维护性**: 使用工具函数减少重复代码

## 注意事项

1. 部分API（如登录）当前处于未完全实现状态，测试用例已为完整实现做好准备
2. 数据库相关的测试使用了模拟服务，确保测试环境的独立性
3. 认证相关的测试包含了各种权限验证场景
4. 所有异步操作都使用了适当的错误处理测试

## 未来改进

1. 添加集成测试，测试完整的API流程
2. 增加性能测试，确保API响应时间
3. 添加更多的边界情况测试
4. 实现API文档自动生成