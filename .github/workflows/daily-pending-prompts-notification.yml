name: Daily Pending Prompts Notification

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´å‡Œæ™¨1ç‚¹ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-pending-prompts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check pending prompts count
        id: check-count
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.API_SECRET_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/admin/prompts/pending-count")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "API request failed with status $http_code"
            exit 1
          fi
          
          # è§£æ JSON å“åº”è·å–å¾…å®¡æ ¸æ•°é‡
          pending_count=$(echo "$body" | jq -r '.data.pendingCount')
          timestamp=$(echo "$body" | jq -r '.data.timestamp')
          
          echo "pending_count=$pending_count" >> $GITHUB_OUTPUT
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          echo "Pending prompts count: $pending_count"

      - name: Send email notification via Resend
        if: steps.check-count.outputs.pending_count != '0'
        run: |
          pending_count="${{ steps.check-count.outputs.pending_count }}"
          timestamp="${{ steps.check-count.outputs.timestamp }}"
          app_url="${{ secrets.APP_URL }}"
          
          # æ„å»ºé‚®ä»¶å†…å®¹
          email_subject="[æç¤ºè¯ç®¡ç†å¹³å°] å¾…å®¡æ ¸æç¤ºè¯é€šçŸ¥ - ${pending_count} æ¡å¾…å¤„ç†"
          email_html="<div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
            <h2 style='color: #333;'>ğŸ“‹ å¾…å®¡æ ¸æç¤ºè¯é€šçŸ¥</h2>
            <p style='font-size: 16px; color: #666;'>æ‚¨å¥½ï¼Œ</p>
            <p style='font-size: 16px; color: #666;'>ç›®å‰æœ‰ <strong style='color: #e74c3c; font-size: 24px;'>${pending_count}</strong> æ¡å…¬å¼€æç¤ºè¯ç­‰å¾…å®¡æ ¸ã€‚</p>
            <div style='background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;'>
              <p style='margin: 0; color: #666;'>ğŸ“… æ£€æŸ¥æ—¶é—´: ${timestamp}</p>
            </div>
            <p style='font-size: 16px; color: #666;'>è¯·ç™»å½•ç®¡ç†åå°è¿›è¡Œå®¡æ ¸ï¼š</p>
            <a href='${app_url}/admin/prompts?isPublic=true&approvalStatus=PENDING'
               style='display: inline-block; background: #3498db; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0;'>
              å‰å¾€å®¡æ ¸
            </a>
            <hr style='border: none; border-top: 1px solid #eee; margin: 30px 0;'>
            <p style='font-size: 12px; color: #999;'>æ­¤é‚®ä»¶ç”±ç³»ç»Ÿè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚</p>
          </div>"
          
          # ä½¿ç”¨ Resend API å‘é€é‚®ä»¶
          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"${{ secrets.RESEND_FROM_EMAIL }}\",
              \"to\": [\"${{ secrets.NOTIFICATION_EMAIL }}\"],
              \"subject\": \"${email_subject}\",
              \"html\": $(echo "$email_html" | jq -Rs .)
            }"
          
          echo "Email notification sent successfully!"

      - name: Log no pending prompts
        if: steps.check-count.outputs.pending_count == '0'
        run: |
          echo "No pending prompts to review. Skipping email notification."